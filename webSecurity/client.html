<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器安全 | FFFXUE</title>
    <meta name="description" content="开发笔记">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/notes/flag.ico">
    
    <link rel="preload" href="/notes/assets/css/0.styles.f3b51880.css" as="style"><link rel="preload" href="/notes/assets/js/app.a41b94f8.js" as="script"><link rel="preload" href="/notes/assets/js/2.c52a3321.js" as="script"><link rel="preload" href="/notes/assets/js/26.3c7d5bfe.js" as="script"><link rel="prefetch" href="/notes/assets/js/10.d40410d8.js"><link rel="prefetch" href="/notes/assets/js/11.368d85aa.js"><link rel="prefetch" href="/notes/assets/js/12.041c7eab.js"><link rel="prefetch" href="/notes/assets/js/13.b16d6551.js"><link rel="prefetch" href="/notes/assets/js/14.8a0a33d8.js"><link rel="prefetch" href="/notes/assets/js/15.b1f74293.js"><link rel="prefetch" href="/notes/assets/js/16.2b45b17b.js"><link rel="prefetch" href="/notes/assets/js/17.ba8bc991.js"><link rel="prefetch" href="/notes/assets/js/18.5522bf27.js"><link rel="prefetch" href="/notes/assets/js/19.5ef2994f.js"><link rel="prefetch" href="/notes/assets/js/20.bd1387b2.js"><link rel="prefetch" href="/notes/assets/js/21.49cd2783.js"><link rel="prefetch" href="/notes/assets/js/22.015468ac.js"><link rel="prefetch" href="/notes/assets/js/23.f8a0f975.js"><link rel="prefetch" href="/notes/assets/js/24.2bc3eae7.js"><link rel="prefetch" href="/notes/assets/js/25.37819e9d.js"><link rel="prefetch" href="/notes/assets/js/27.b58d79b7.js"><link rel="prefetch" href="/notes/assets/js/28.dcf04f1f.js"><link rel="prefetch" href="/notes/assets/js/29.afebf154.js"><link rel="prefetch" href="/notes/assets/js/3.5e110c6a.js"><link rel="prefetch" href="/notes/assets/js/4.b0dd307f.js"><link rel="prefetch" href="/notes/assets/js/5.80900f81.js"><link rel="prefetch" href="/notes/assets/js/6.11c4bab6.js"><link rel="prefetch" href="/notes/assets/js/7.e0955c7f.js"><link rel="prefetch" href="/notes/assets/js/8.16f41505.js"><link rel="prefetch" href="/notes/assets/js/9.b1625156.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.f3b51880.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">FFFXUE</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/algorithm/" class="nav-link">
  算法与数据结构
</a></div><div class="nav-item"><a href="/notes/network/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><a href="/notes/designPatterns/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web系列" class="dropdown-title"><span class="title">Web系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/webSecurity/client/" class="nav-link">
  Web安全
</a></li><li class="dropdown-item"><!----> <a href="/notes/browser/" class="nav-link">
  浏览器工作原理与实践
</a></li><li class="dropdown-item"><!----> <a href="/notes/kit/bundler/" class="nav-link">
  玩具工具包
</a></li></ul></div></div> <a href="https://github.com/hakuna-tata/notes/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/algorithm/" class="nav-link">
  算法与数据结构
</a></div><div class="nav-item"><a href="/notes/network/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><a href="/notes/designPatterns/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web系列" class="dropdown-title"><span class="title">Web系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/webSecurity/client/" class="nav-link">
  Web安全
</a></li><li class="dropdown-item"><!----> <a href="/notes/browser/" class="nav-link">
  浏览器工作原理与实践
</a></li><li class="dropdown-item"><!----> <a href="/notes/kit/bundler/" class="nav-link">
  玩具工具包
</a></li></ul></div></div> <a href="https://github.com/hakuna-tata/notes/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Web安全漏洞分析与防御</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/webSecurity/client.html" class="active sidebar-link">客户端脚本安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/webSecurity/client.html#浏览器安全" class="sidebar-link">浏览器安全</a></li><li class="sidebar-sub-header"><a href="/notes/webSecurity/client.html#跨站脚本攻击-xss" class="sidebar-link">跨站脚本攻击(XSS)</a></li><li class="sidebar-sub-header"><a href="/notes/webSecurity/client.html#跨站请求伪造-csrf" class="sidebar-link">跨站请求伪造(CSRF)</a></li><li class="sidebar-sub-header"><a href="/notes/webSecurity/client.html#点击劫持-clickjacking" class="sidebar-link">点击劫持(ClickJacking)</a></li></ul></li><li><a href="/notes/webSecurity/transport.html" class="sidebar-link">流量劫持</a></li><li><a href="/notes/webSecurity/server.html" class="sidebar-link">服务端应用安全</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="浏览器安全"><a href="#浏览器安全" class="header-anchor">#</a> 浏览器安全</h2> <blockquote><p>随着互联网的发展， <strong>浏览器</strong> 成为互联网最大的入口。因此浏览器市场竞争也越发激烈，所以浏览器带来的安全功能也越来越
强大，这也成为各大浏览器厂商之前竞争的一张底牌。</p></blockquote> <p>浏览器一些主要的安全功能有：</p> <ol><li><strong>同源策略:</strong></li></ol> <ul><li><p>浏览器的同源策略，限制了来自不同源的“document”或脚本，对当前“document”读取或设置某些属性</p> <p>同源的条件（必须全部满足）：</p> <ul><li>protocol(协议)</li> <li>host(子域名)</li> <li>port(端口)</li></ul></li></ul> <ol start="2"><li><strong>CSP(Content Security Policy)</strong></li></ol> <ul><li>在HTTP的响应头中设定CSP的规则，可以规定当前网页可以加载的资源的白名单（指定哪些内容可以执行），从而减少网页受到XSS攻击的风险。所以说CSP是一个在现代浏览器加载资源白名单的安全机制，只有响应头中白名单里列出的资源才能够被加载、执行。</li></ul> <ol start="3"><li><strong>恶意网址拦截</strong></li></ol> <ul><li>恶意网址拦截一般就是浏览器周期性从服务端获取一份恶意网址黑名单，如果用户上网时访问的网站存在于此黑名单中，浏览器就会弹出一个警告页面。</li></ul> <ol start="4"><li><strong>浏览器沙箱</strong></li></ol> <ul><li>现代浏览器都是采用多进程架构，带来额外的好处就是可以使⽤安全沙箱。沙箱可以看成是操作系统给进程上了⼀把锁，沙箱⾥⾯的程序可以运⾏，但是不能在你的硬盘上写⼊任何数据，也不能在敏感位置读取任何数据，例如你的⽂档和桌⾯。<strong>浏览器把插件进程和渲染进程锁在沙箱⾥⾯，这样即使在渲染进程或者插件进程⾥⾯执⾏了恶意程序，恶意程序也⽆法突破沙箱去获取系统权限。</strong></li></ul> <blockquote><p>注：浏览器加载的第三方插件可能不受Sandbox管辖，因此这成为了现代浏览器攻击的热点。</p></blockquote> <h2 id="跨站脚本攻击-xss"><a href="#跨站脚本攻击-xss" class="header-anchor">#</a> 跨站脚本攻击(XSS)</h2> <blockquote><p><em><strong>跨站脚本攻击</strong></em>，英文全称是Cross Site Script，本来缩写是CSS，但是为了和层叠样式表（CSS）有所区别,所以在安全领域叫做“XSS”。<br>
XSS攻击是攻击者能够对用户当前浏览的页面植入恶意脚本，通过恶意脚本，控制用户的浏览器来执行一些违背用户的操作。</p></blockquote> <p><strong>XSS攻击</strong>分为反射型（url参数直接注入）和存储型（存储到DB后读取注入）</p> <p>常见的XSS攻击注入点：</p> <ol><li><strong>HTML节点内容：</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">//let data = &quot;&lt;script&gt;alert(123)&lt;/script&gt;&quot;</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>script <span class="token operator">?</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>script <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>包含了反射型XSS攻击的用户请求：<br> <img src="/notes/webSecurity/xss/xss-dom1.png" style="display:block;margin:0 auto;"></li> <li>包含了存储型XSS攻击的用户请求：
<img src="/notes/webSecurity/xss/xss-dom2.png" style="display:block;margin:0 auto;"></li></ul> <ol start="2"><li><strong>HTML属性</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

 <span class="token comment">//let imageSrc = '&quot; onerror=&quot;alert(123)&quot;'</span>

 router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> imageSrc <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>imageSrc
   ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
     <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
       &lt;img src=&quot;image/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>imageSrc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
     &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>

 app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

 app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>包含了反射型XSS攻击的用户请求：
<img src="/notes/webSecurity/xss/xss-atr1.png" style="display:block;margin:0 auto;"></li> <li>包含了存储型XSS攻击的用户请求：略</li></ul> <ol start="3"><li><strong>JS代码</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> test <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>test
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
        &lt;script&gt;
          var test = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>test<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        &lt;/script&gt;
      &lt;/div&gt;
      </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>包含了反射型XSS攻击的用户请求：
<img src="/notes/webSecurity/xss/xss-js1.png" style="display:block;margin:0 auto;"></li> <li>包含了存储型XSS攻击的用户请求：略</li></ul> <ol start="4"><li><strong>富文本</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">//有时候网站需要用户提交一些自定的HTML代码，称为“富文本”。比如一些帖子的内容要有图片，视频，</span>
  <span class="token comment">//表格等。这些“富文本”的效果都需要通过HTML代码来实现</span>

  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;img src=&quot;1&quot; onerror=&quot;alert(1)&quot;&gt;
      &lt;script&gt;alert(2)&lt;/script&gt;
      &lt;div&gt;正常&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>包含了存储型XSS攻击的用户请求：
<img src="/notes/webSecurity/xss/xss-rt1.png" style="display:block;margin:0 auto;"></li></ul> <p>常见的XSS防御措施：</p> <ol><li><strong>Set-Cookie时设置httpOnly标记</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;fffxue&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>httpOnly<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;22&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>httpOnly<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
</code></pre></div><ul><li>客户端JS无法获取设置httpOnly的Cookie：
<img src="/notes/webSecurity/xss/xss-cookie.png" style="display:block;margin:0 auto;"></li></ul> <ol start="2"><li><strong>HTML节点内容转译：</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">escapeHtml</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&amp;/g</span><span class="token punctuation">,</span><span class="token string">'&amp;amp;'</span><span class="token punctuation">)</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;/g</span><span class="token punctuation">,</span><span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&gt;/g</span><span class="token punctuation">,</span><span class="token string">'&amp;gt;'</span><span class="token punctuation">)</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&quot;/g</span><span class="token punctuation">,</span><span class="token string">'&amp;quto;'</span><span class="token punctuation">)</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/'/g</span><span class="token punctuation">,</span><span class="token string">'&amp;#39;'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> str
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>script <span class="token operator">?</span> <span class="token function">escapeHtml</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>处理结果：
<img src="/notes/webSecurity/xss/xss-dom3.png" style="display:block;margin:0 auto;"></li></ul> <ol start="3"><li><strong>HTML属性转译</strong></li></ol> <ul><li>处理结果：
<img src="/notes/webSecurity/xss/xss-atr2.png" style="display:block;margin:0 auto;"></li></ul> <ol start="4"><li><strong>JS代码转义</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
        &lt;script&gt;
          var text = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        &lt;/script&gt;
      &lt;/div&gt;
      </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>处理结果：
<img src="/notes/webSecurity/xss/xss-js2.png" style="display:block;margin:0 auto;"></li></ul> <ol start="5"><li><strong>富文本白名单过滤</strong>(GitHub:XSS第三方库)</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cheerio&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;img src=&quot;1&quot; onerror=&quot;alert(1)&quot;&gt;
      &lt;script&gt;alert(2)&lt;/script&gt;
      &lt;div&gt;正常&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>

  <span class="token keyword">const</span> <span class="token function-variable function">xssFilter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>

    <span class="token comment">// 白名单</span>
    <span class="token keyword">var</span> whiteList <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;html&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;body&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;div&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;img&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;a&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span>elem</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>whiteList<span class="token punctuation">[</span>elem<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> attr <span class="token keyword">in</span> elem<span class="token punctuation">.</span>attribs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>whiteList<span class="token punctuation">[</span>elem<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">xssFilter</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>处理结果：
<img src="/notes/webSecurity/xss/xss-rt2.png" style="display:block;margin:0 auto;"></li></ul> <ol start="6"><li><strong>CSP</strong>(同浏览器安全介绍)</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">&quot;/*&quot;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Content-Security-Policy</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>`<span class="token keyword">default</span><span class="token operator">-</span>src <span class="token string">'self'</span>`<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>处理结果：
<img src="/notes/webSecurity/xss/xss-csp.png" style="display:block;margin:0 auto;"></li></ul> <p><strong>总结：</strong></p> <blockquote><p><strong>XSS漏洞虽然复杂，但是是可以解决的。设计XSS解决方案时，应该深入理解XSS攻击原理，针对不同场景使用不同的方法。</strong></p></blockquote> <h2 id="跨站请求伪造-csrf"><a href="#跨站请求伪造-csrf" class="header-anchor">#</a> 跨站请求伪造(CSRF)</h2> <blockquote><p><em><strong>跨站请求伪造</strong></em>，英文全称是Cross Site Request Forgery。是一种在攻击者的网站，在用户毫不知情的情况下向用户的网站
发起请求。比如发生一些删帖，转载，购买等操作。</p></blockquote> <p>CSRF攻击的演示：</p> <ol><li>先运行自己的服务器</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test/:test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>test <span class="token operator">?</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>test <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>content <span class="token operator">?</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>content <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;delete post&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><ol start="2"><li>攻击者构造一个页面</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token constant">CSRF</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;http://localhost:8000/test/我来自csrf?content= &lt;a href='C:\Users\liujianfeng\Desktop\test.html'&gt;点击有Q币领取&lt;/a&gt;&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre></div><ul><li>当用户点击攻击者构造页面的链接：
<img src="/notes/webSecurity/csrf/csrf-1.png" style="display:block;margin:0 auto;"></li></ul> <p>其实：</p> <blockquote><p><em><strong>CSRF</strong></em> 攻击原理就是攻击者窃取用户的身份信息（Cookie）向用户网站发起请求（form表单，image标
签，a标签等）</p></blockquote> <p>CSRF的防御：</p> <ol><li><p><strong>验证码</strong><br>
CSRF的攻击过程，往往是在用户不知情的情况下构造了网络请求。而验证码则强制用户必须与应用进行交互，
才能完成最终请求。<br>
但是验证码并不是万能。很多时候出于用户体验考虑，网站不能给所有的操作都加上验证码，所以验证码只能
作为防御CSRF的一种辅助手段。</p></li> <li><p><strong>Referer Check</strong><br>
Referer Check可以检查请求是否来自合法的“源”</p></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> referer <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^https?:\/\/localhost/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>referer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;referer&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;非法地址&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li><p><strong>Token</strong><br>
Token就是随机数加密与后端校验的一种方式</p></li> <li><p><strong>sameSite</strong><br>
Cookie的sameSite属性用来限制第三方Cookie:<br>
1.Strict最为严格，完全禁止第三方 Cookie，跨站点时，任何情况下都不会发送Cookie。换言之，只有当前网页的URL与请求目标一致，才会带上Cookie。<br>
2.Lax规则稍稍放宽，大多数情况也是不发送第三方Cookie，但是导航到目标网址的Get请求除外。</p></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;22&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>httpOnly<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>sameSite：<span class="token string">&quot;strict&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Server] starting at port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
</code></pre></div><p><strong>总结：</strong></p> <blockquote><p>CRSF攻击是攻击者利用用户的身份操作用户账号的一种方式。设计CSRF的防御方案必须先理解其原理和本质，而且和XSS防御相辅相成。</p></blockquote> <h2 id="点击劫持-clickjacking"><a href="#点击劫持-clickjacking" class="header-anchor">#</a> 点击劫持(ClickJacking)</h2> <blockquote><p><em><strong>点击劫持</strong></em>，是一种视觉上的欺骗手段。攻击者使用一个透明，不可见的iframe,覆盖在
一个网页上，然后诱使用户在该页面上进行操作，此时用户将在不知情的情况下点击透明的iframe页面。通过
调整iframe页面的位置，可以诱使用户恰好点击在iframe页面的一些功能性按钮上。</p></blockquote> <p>点击劫持攻击的演示：</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token doctype">&lt;!DOCTYPE html&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>ClickJacking<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">iframe</span><span class="token punctuation">{</span>
        <span class="token property">opacity</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
        <span class="token property">z-index</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token selector">button</span><span class="token punctuation">{</span>
        <span class="token property">top</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span>
        <span class="token property">left</span><span class="token punctuation">:</span>190px<span class="token punctuation">;</span>
        <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
        <span class="token property">z-index</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> #c09<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.emdoor.com/<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>800<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>600<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>Click Here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>当iframe半透明的时候，我们看到button其实覆盖在另一个网页，当我们点击button的时候其实是点击网页的某个操作：
<img src="/notes/webSecurity/clickJacking/cj1.png" style="display:block;margin:0 auto;"></li></ul> <p>所以：</p> <blockquote><p><em><strong>点击劫持</strong></em>，本质是一种视觉欺骗，顺着这些思路也出现了一些类似图片覆盖，拖拽等类似攻击</p></blockquote> <p>ClickJacking的防御：</p> <ol><li><strong>使用JS禁止内嵌iframe</strong></li></ol> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">if</span><span class="token punctuation">(</span>top<span class="token punctuation">.</span>location <span class="token operator">!=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">{</span>
      top<span class="token punctuation">.</span>location <span class="token operator">=</span> window<span class="token punctuation">.</span>location
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div> <img src="/notes/webSecurity/clickJacking/cj2.png" style="display:block;margin:0 auto;"> <p><strong>但是有很多办法可以绕过JS代码，比如H5中iframe的sandbox属性，IE中iframe的security属性等，都可以使JS代码失效</strong></p> <ol start="2"><li><strong>设置X-FRAME-OPTIONS禁止内嵌</strong></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  response<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;X-Frame-Options&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;DENY || SAME-ORIGIN || ...&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>总结：</strong></p> <blockquote><p>ClickJacking相对于XSS和CSRF来说，因为需要诱使用户与页面产生交互行为，因此攻击成本高，在安全方面比较少见，
但还是不可不防。</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-3-12 12:58:59 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/notes/webSecurity/transport.html">
        流量劫持
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notes/assets/js/app.a41b94f8.js" defer></script><script src="/notes/assets/js/2.c52a3321.js" defer></script><script src="/notes/assets/js/26.3c7d5bfe.js" defer></script>
  </body>
</html>
